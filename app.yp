import streamlit as st
import ccxt
import pandas as pd
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import datetime

# --- 1. é¡µé¢é…ç½® ---
st.set_page_config(page_title="ä¸‰çº§ç­–ç•¥å“¨å…µ", layout="wide", page_icon="ğŸ›¡ï¸")
st.title("ğŸ›¡ï¸ Crypto Sentinel - å…¨å‘¨æœŸç­–ç•¥å¯è§†åŒ–")

# --- 2. ä¾§è¾¹æ é…ç½® ---
st.sidebar.header("ğŸ¯ ç›‘æ§è®¾ç½®")
symbol = st.sidebar.text_input("è¾“å…¥å¸ç§ (ä¾‹å¦‚ BTC/USDT)", value="BTC/USDT")
exchange_id = st.sidebar.selectbox("æ•°æ®æºäº¤æ˜“æ‰€", ['binance', 'gate', 'okx', 'mexc'])

# --- 3. æ ¸å¿ƒè®¡ç®—å¼•æ“ (ä¸ä¾èµ–å¤æ‚åº“ï¼Œçº¯Pandaså®ç°) ---
def calculate_indicators(df):
    # A. çŸ­çº¿æŒ‡æ ‡: Bollinger Bands & RSI
    df['TP'] = (df['high'] + df['low'] + df['close']) / 3
    df['std'] = df['TP'].rolling(20).std()
    df['MA20'] = df['TP'].rolling(20).mean()
    df['Upper_BB'] = df['MA20'] + 2 * df['std']
    df['Lower_BB'] = df['MA20'] - 2 * df['std']
    
    # RSI è®¡ç®—
    delta = df['close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
    rs = gain / loss
    df['RSI'] = 100 - (100 / (1 + rs))

    # B. ä¸­çº¿æŒ‡æ ‡: MA Cross & MACD
    df['MA7'] = df['close'].rolling(7).mean()
    df['MA30'] = df['close'].rolling(30).mean()
    
    exp1 = df['close'].ewm(span=12, adjust=False).mean()
    exp2 = df['close'].ewm(span=26, adjust=False).mean()
    df['MACD'] = exp1 - exp2
    df['Signal_Line'] = df['MACD'].ewm(span=9, adjust=False).mean()

    # C. é•¿çº¿æŒ‡æ ‡: MA200
    df['MA200'] = df['close'].rolling(200).mean()
    
    return df

def fetch_data(symbol, timeframe, limit=300):
    try:
        exchange_class = getattr(ccxt, exchange_id)
        exchange = exchange_class()
        ohlcv = exchange.fetch_ohlcv(symbol, timeframe, limit=limit)
        df = pd.DataFrame(ohlcv, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
        df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')
        return calculate_indicators(df)
    except Exception as e:
        st.error(f"æ•°æ®è·å–å¤±è´¥: {e}")
        return pd.DataFrame()

# --- 4. ç»˜å›¾ä¸ä¿¡å·é€»è¾‘ ---

# >>> ç­–ç•¥ 1: çŸ­çº¿åšT (15m/1h) - å›å½’ç­–ç•¥ <<<
def render_short_term():
    st.markdown("### ğŸ¹ çŸ­çº¿å“¨å…µ (Short-Term): åšTç¥å™¨")
    st.info("ç­–ç•¥é€»è¾‘: ä»·æ ¼è§¦ç¢°å¸ƒæ—å¸¦ä¸‹è½¨+RSIè¶…å–=ä¹°å…¥; è§¦ç¢°ä¸Šè½¨+RSIè¶…ä¹°=å–å‡º")
    
    col1, col2 = st.columns([3, 1])
    timeframe = col2.selectbox("çŸ­çº¿å‘¨æœŸ", ['15m', '1h'], index=0)
    
    df = fetch_data(symbol, timeframe)
    if df.empty: return

    # ç”Ÿæˆä¿¡å·
    # ä¹°å…¥ä¿¡å·ï¼šæ”¶ç›˜ä»· < ä¸‹è½¨ ä¸” RSI < 35
    buy_signals = df[(df['close'] < df['Lower_BB']) & (df['RSI'] < 35)]
    # å–å‡ºä¿¡å·ï¼šæ”¶ç›˜ä»· > ä¸Šè½¨ ä¸” RSI > 65
    sell_signals = df[(df['close'] > df['Upper_BB']) & (df['RSI'] > 65)]

    # ç»˜å›¾
    fig = make_subplots(rows=2, cols=1, shared_xaxes=True, vertical_spacing=0.03, row_heights=[0.7, 0.3])
    
    # Kçº¿
    fig.add_trace(go.Candlestick(x=df['timestamp'], open=df['open'], high=df['high'], low=df['low'], close=df['close'], name='Kçº¿'), row=1, col=1)
    
    # å¸ƒæ—å¸¦
    fig.add_trace(go.Scatter(x=df['timestamp'], y=df['Upper_BB'], line=dict(color='rgba(255, 0, 0, 0.5)', width=1), name='ä¸Šè½¨'), row=1, col=1)
    fig.add_trace(go.Scatter(x=df['timestamp'], y=df['Lower_BB'], line=dict(color='rgba(0, 255, 0, 0.5)', width=1), name='ä¸‹è½¨'), row=1, col=1)

    # æ ‡è®°ä¿¡å·
    fig.add_trace(go.Scatter(mode='markers', x=buy_signals['timestamp'], y=buy_signals['low']*0.995, 
                             marker=dict(symbol='triangle-up', color='green', size=12), name='ä¹°å…¥åšT'), row=1, col=1)
    fig.add_trace(go.Scatter(mode='markers', x=sell_signals['timestamp'], y=sell_signals['high']*1.005, 
                             marker=dict(symbol='triangle-down', color='red', size=12), name='å–å‡ºåšT'), row=1, col=1)

    # RSI
    fig.add_trace(go.Scatter(x=df['timestamp'], y=df['RSI'], line=dict(color='purple', width=2), name='RSI'), row=2, col=1)
    fig.add_hline(y=70, line_dash="dot", row=2, col=1, line_color="red")
    fig.add_hline(y=30, line_dash="dot", row=2, col=1, line_color="green")

    fig.update_layout(height=600, margin=dict(l=20, r=20, t=20, b=20))
    st.plotly_chart(fig, use_container_width=True)

    # å®æ—¶æé†’
    last_row = df.iloc[-1]
    if last_row['close'] < last_row['Lower_BB']:
        st.warning(f"âš ï¸ ç°ä»·ä½äºå¸ƒæ—ä¸‹è½¨ï¼RSI: {last_row['RSI']:.2f} - å…³æ³¨åå¼¹æœºä¼š")
    elif last_row['close'] > last_row['Upper_BB']:
        st.warning(f"âš ï¸ ç°ä»·é«˜äºå¸ƒæ—ä¸Šè½¨ï¼RSI: {last_row['RSI']:.2f} - åªæœ‰å›è°ƒé£é™©")
    else:
        st.success("ç›®å‰ä»·æ ¼åœ¨å¸ƒæ—å¸¦é€šé“å†…ï¼Œæ— æç«¯ä¿¡å·ã€‚")


# >>> ç­–ç•¥ 2: ä¸­çº¿æ³¢æ®µ (4h/1d) - è¶‹åŠ¿ç­–ç•¥ <<<
def render_medium_term():
    st.markdown("### ğŸŒŠ ä¸­çº¿å“¨å…µ (Medium-Term): è¶‹åŠ¿å†²æµª")
    st.info("ç­–ç•¥é€»è¾‘: MA7ä¸Šç©¿MA30(é‡‘å‰)=æŒå¸; MA7ä¸‹ç©¿MA30(æ­»å‰)=ç©ºä»“")

    col1, col2 = st.columns([3, 1])
    timeframe = col2.selectbox("ä¸­çº¿å‘¨æœŸ", ['4h', '1d'], index=0)
    
    df = fetch_data(symbol, timeframe, limit=100)
    if df.empty: return

    # ç»˜å›¾
    fig = go.Figure()
    fig.add_trace(go.Candlestick(x=df['timestamp'], open=df['open'], high=df['high'], low=df['low'], close=df['close'], name='Kçº¿'))
    
    # å‡çº¿
    fig.add_trace(go.Scatter(x=df['timestamp'], y=df['MA7'], line=dict(color='orange', width=2), name='MA7 (å¿«çº¿)'))
    fig.add_trace(go.Scatter(x=df['timestamp'], y=df['MA30'], line=dict(color='blue', width=2), name='MA30 (æ…¢çº¿)'))

    # åˆ¤æ–­å½“å‰è¶‹åŠ¿
    last_row = df.iloc[-1]
    trend = "UP" if last_row['MA7'] > last_row['MA30'] else "DOWN"
    
    # èƒŒæ™¯è‰²æš—ç¤º
    bg_color = "rgba(0, 255, 0, 0.05)" if trend == "UP" else "rgba(255, 0, 0, 0.05)"
    fig.update_layout(plot_bgcolor=bg_color, height=500)
    
    st.plotly_chart(fig, use_container_width=True)

    if trend == "UP":
        st.success(f"ğŸ“ˆ å½“å‰å¤„äº **ä¸Šå‡è¶‹åŠ¿** (MA7 > MA30)ã€‚å»ºè®®ï¼šæŒå¸å¾…æ¶¨ï¼Œé€¢ä½ä¹°å…¥ã€‚")
    else:
        st.error(f"ğŸ“‰ å½“å‰å¤„äº **ä¸‹è·Œè¶‹åŠ¿** (MA7 < MA30)ã€‚å»ºè®®ï¼šç©ºä»“æˆ–è°¨æ…åšç©ºã€‚")


# >>> ç­–ç•¥ 3: é•¿çº¿å‘¨æœŸ (1w/1M) - ä»·å€¼å›å½’ <<<
def render_long_term():
    st.markdown("### ğŸ”ï¸ é•¿çº¿å“¨å…µ (Long-Term): å‘¨æœŸå®šä½")
    st.info("ç­–ç•¥é€»è¾‘: ä»·æ ¼åœ¨MA200ä¹‹ä¸Š=ç‰›å¸‚åŒºåŸŸ; ä»·æ ¼åœ¨MA200ä¹‹ä¸‹=ç†Šå¸‚æŠ„åº•åŒºåŸŸ")

    col1, col2 = st.columns([3, 1])
    timeframe = col2.selectbox("é•¿çº¿å‘¨æœŸ", ['1d', '1w'], index=0) # é•¿çº¿é€šå¸¸çœ‹æ—¥çº¿çš„MA200æˆ–å‘¨çº¿
    
    # éœ€è¦æ›´å¤šæ•°æ®æ¥è®¡ç®—MA200
    df = fetch_data(symbol, timeframe, limit=300)
    if df.empty: return

    last_price = df.iloc[-1]['close']
    ma200 = df.iloc[-1]['MA200']
    
    # è®¡ç®—åç¦»åº¦
    deviation = ((last_price - ma200) / ma200) * 100
    
    # ä»ªè¡¨ç›˜ç»˜åˆ¶
    fig = go.Figure(go.Indicator(
        mode = "gauge+number+delta",
        value = last_price,
        domain = {'x': [0, 1], 'y': [0, 1]},
        title = {'text': f"å½“å‰ä»·æ ¼ vs MA200ç‰›ç†Šåˆ†ç•Œçº¿ (${ma200:.2f})"},
        delta = {'reference': ma200, 'increasing': {'color': "green"}, 'decreasing': {'color': "red"}},
        gauge = {
            'axis': {'range': [ma200 * 0.5, ma200 * 1.5]},
            'bar': {'color': "darkblue"},
            'steps': [
                {'range': [ma200 * 0.5, ma200], 'color': "lightpink"}, # ç†Šå¸‚/ä½ä¼°åŒº
                {'range': [ma200, ma200 * 1.5], 'color': "lightgreen"}], # ç‰›å¸‚/é«˜ä¼°åŒº
            'threshold': {
                'line': {'color': "red", 'width': 4},
                'thickness': 0.75,
                'value': last_price}
        }
    ))
    
    fig.update_layout(height=400)
    st.plotly_chart(fig, use_container_width=True)

    st.metric("è·ç¦» MA200 åç¦»åº¦", f"{deviation:.2f}%")
    if last_price > ma200:
        st.success("ğŸŸ¢ å¸‚åœºå¤„äº **ç‰›å¸‚** åŒºåŸŸ (ä»·æ ¼ > 200æ—¥å‡çº¿)ã€‚é•¿çº¿å»ºè®®ï¼šæŒæœ‰åº•ä»“ã€‚")
    else:
        st.warning("ğŸ”´ å¸‚åœºå¤„äº **ç†Šå¸‚/éœ‡è¡** åŒºåŸŸ (ä»·æ ¼ < 200æ—¥å‡çº¿)ã€‚é•¿çº¿å»ºè®®ï¼šå¼€å¯å®šæŠ•æ¨¡å¼ã€‚")


# --- 5. ä¸»ç•Œé¢é€‰é¡¹å¡æ§åˆ¶ ---
tab1, tab2, tab3 = st.tabs(["ğŸ¹ çŸ­çº¿åšT (å°æ—¶çº§)", "ğŸŒŠ ä¸­çº¿æ³¢æ®µ (æ—¥çº¿çº§)", "ğŸ”ï¸ é•¿çº¿å‘¨æœŸ (å¹´çº¿çº§)"])

with tab1:
    if st.button("ğŸ”„ åˆ·æ–°çŸ­çº¿åˆ†æ", key='btn1'):
        pass 
    render_short_term()

with tab2:
    if st.button("ğŸ”„ åˆ·æ–°ä¸­çº¿åˆ†æ", key='btn2'):
        pass
    render_medium_term()

with tab3:
    if st.button("ğŸ”„ åˆ·æ–°é•¿çº¿åˆ†æ", key='btn3'):
        pass
    render_long_term()
